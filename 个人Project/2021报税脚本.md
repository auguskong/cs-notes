我的需求



将Robinhood / TD 的1099表格当中被标记为Wash Sale的所有交易记录找到并提取出来



将找到的交易记录添加到8949表单PDF中



如果一张表单文件放不下的话 需要用到多张表单 并自动命名? 或者说是重用 最后能够直接打印



不断尝试 -> 实验 -> 确定能不能work



先将PDF 转为 CSV 从CSV中读取数据 -> 将CSV



设计到的操作:

1. 文件导入 文件内容提取
2. 文件写入  
3. 多个文件的拆分
4. 文件的导出



一个文件就搞定了



看起来比较靠谱

TrapRange:  直接从页面截取特定坐标的元素算法  

https://github.com/thoqbk/traprange



原理介绍文章: https://dzone.com/articles/traprange-method-extract-table





另一个思路是先把PDF转成图片 然后用OpenCV进行表格数据的提取

详情: https://stackoverflow.com/questions/47533875/how-to-extract-table-as-text-from-the-pdf-using-python



PyPDF2 是读取Text 或者基本的PDF文件操作 分隔、合并、转换

Documentation: 

https://pythonhosted.org/PyPDF2/index.html

PyPDF2的一些基本操作

https://automatetheboringstuff.com/chapter13/





OCRmyPDF: 将PDF 转换成可以搜索的

https://github.com/jbarlow83/OCRmyPDF



Pdfminder: 能提取简单信息

https://github.com/pdfminer/pdfminer.six 

https://pdfminersix.readthedocs.io/en/latest/index.html







## 设计

完成了单页面的信息提取之后 

多页面提取

每个页面的数据都存在同一个data frame 当中



`df.append()` 会return 一个新的object 需要用新的变量来catch一下 不然就一直是empty

两个



将数据提取到dataframe 如何取出来已经拿到的data?

如何让`pyautogui` 使用dataframe中的数据 ?



先试试直接随便向8949表格里面随便输入两行数据



使用截图工具来定位 每个位置坐标



/Users/xiangyu/Documents/CS/repos/homebrew

```python
df = df[['mean', 4,3,2,1]]
# 更新dataframe的column name
```





https://stackoverflow.com/a/11287278

```python
# 提取已经存在的特定column
df1 = df[['a', 'b']]
```







## Debug

* 
* 运行 
* ERROR: Could not find a version that satisfies the requirement requirements.txt (from versions: none)`

需要使用`-r`来表示我们是从一个 requirement file 中安装 `pip install -r requirements.txt` 

```
-r, --requirement <file>    Install from the given requirements file. This option can be used multiple times.
```



需要disable vimium 来启用Jupyter Notebook 的快捷键



* 在command line 里面source vimrc 会有问题 需要在vim中通过 `:source ~/.vimrc` 来避免

  ```➜  ~ source ~/.vimrc
  /Users/xiangyu/.vimrc:1: command not found: syntax
  ```





会点错位置 因为运行的太快了 导致出现了冲突

需要考虑python 脚本内的程序执行顺序



可以实现copy & paste 结合 `pyperclip`





可以click 和 press button 但是如何copy paste data ? 

将dataframe 文件导出来 

按row来提取? 需要循环 遍历一下 ?

```python
>>> df = pd.DataFrame([[1,2,3],[3,4,5]])
>>> lol = df.values.tolist()
>>> lol
[[1L, 2L, 3L], [3L, 4L, 5L]]
```





先把数据放到剪切板 然后从剪切板里面 paste

```python
pyperclip.copy('abc')
pyautogui.hotkey('command', 'v')
```



python 文件整合? 如何让多个文件之间可以共享信息? 需要一个main file? 



先用visual模式选择要copy的所有文本 然后 `"+y` 

会在vim的最底下 显示 `xx lines yanked into "+` 表示成功复制到buffer当中





为什么data sold 一直是v呢? 

![image-20210327212018000](/Users/xiangyu/Library/Application Support/typora-user-images/image-20210327212018000.png)



而且是有时候是 v 有时候不是v 为什么? 

先试一下用for loop 来进行多次操作的话 靠后的数据是否会恢复正常





* `local variable 'curr_row_index' referenced before assignment`



已经定义了 `curr_row_index = 0`  为什么还是会报错呢? 因为Python是在默认的function 内部来寻找f



https://stackoverflow.com/a/17506974

Due to this line `count +=1` python thinks that `count` is a local variable and will not search the global scope when you used `if count == 3:`. That's why you got that error.

Use `global` statement to handle that:

```py
def three_upper(s): #check for 3 upper letter
    global count
    for i in s:
```

From [docs](http://docs.python.org/release/1.5.1p1/tut/functions.html):

> All variable assignments in a function store the value in the local symbol table; whereas variable references first look in the local symbol table, then in the global symbol table, and then in the table of built-in names. Thus, global variables cannot be directly assigned a value within a function (unless named in a global statement), although they may be referenced.



需要对数据进行一些过滤处理

直接remove 不需要的Total 行 

同时Quantity 需要添加到Description 当中 而不是按照顺序来的 需要进行调整







## Research

pdfminer: https://pdfminer-docs.readthedocs.io/programming.html



pdfminer class relationship

![image-20210321130214577](/Users/xiangyu/Library/Application Support/typora-user-images/image-20210321130214577.png)



* `PDFParser`: fetch data from a filie
* `PDFDocument`: store data
* `PDFPageInterpreter`: process the page contents
* `PDFDevice`: translate page contents
* `PDFResourceManger`: store shared resources such as fonts or images



Layout Representation

![image-20210321130044962](/Users/xiangyu/Library/Application Support/typora-user-images/image-20210321130044962.png)



PDF is more like a graphic representation. In most cases, it has no logical structure such as sentences or paragraphs and it cannot adapt itself when the paper size changes.



先做拆分 然后再进行提取









## Demo 源码分析



为什么要先提取characters  -> rows -> texts ? 

用什么算法来找到每一行? 



TextBox 可以用数学公式来进行计算和拆分吗?  e.g. 每相邻9个box 是同一行的? 



最后能够直接提取出来每一行的信息 但是有的时候 various 是单独在一个List当中 有的时候不是 这是为什么呢? 



同时还需要过滤掉 Total的  作为过滤条件的选项: 

* List 的长度 `len(texts[34]) == 8`
* 正则表达式 
* 是否包单个的`W` 字符



下一步将DataFrame的数据写入到PDF文件中 



1.



过滤的话是用哪个function ?





搞定了从第一页里面进行提取 现在要把所有页面的都取出来

加一个for loop 即可

`page_layouts` contains all information 

loop through every page to extract information 



extract_text 

extract_characters

arrange+text





提取出数据之后需要用 `pyautogui` 包 来将输入数据的流程自动化





在vim 中直接运行python程序

https://stackoverflow.com/a/52186237

```py
! clear; python %
```

[![enter image description here](https://i.stack.imgur.com/MJBGZ.gif)](https://i.stack.imgur.com/MJBGZ.gif)



> `!` allows you to run a terminal command
>
> `clear` will empty your terminal screen
>
> `;` ends the first command, allowing you to introduce a second command
>
> `python` will use python to run your script (it could be replaced with `ruby` for example)
>
> `%` concats the current filename, passing it as a parameter to the `python` command



## Q&A

* 如何将dataframe数据转换成dictionary 来方便提取 

  * https://stackoverflow.com/a/26716774

  ```python
  df.to_dict('records')
  # 生成了一个list of dicts 
  
  >>> df.to_dict('records')
  [{'a': 'red', 'b': 0.5}, 
   {'a': 'yellow', 'b': 0.25}, 
   {'a': 'blue', 'b': 0.125}]
  ```

  

```python
for idx, val in enumerate(ints):
	print(idx, val) # get index and value
```





## Change Log



* 3.27 
  * 完成多个页面的信息提取
  * 通过使用`pyautogui`成功复制粘贴数据到PDF 表格中



* 3.28
  * 需要将全部的data都复制粘贴到PDF中